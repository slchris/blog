<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Qubes使用split GPG - Power!</title><meta name=Description content="Qubes使用split GPG"><meta property="og:title" content="Qubes使用split GPG"><meta property="og:description" content="Qubes使用split GPG"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.plz.ac/posts/qubes_split-gpg/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-03-23T12:17:45-04:00"><meta property="article:modified_time" content="2024-03-23T12:17:45-04:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Qubes使用split GPG"><meta name=twitter:description content="Qubes使用split GPG"><meta name=application-name content="Power!"><meta name=apple-mobile-web-app-title content="Power!"><meta name=theme-color content="#f8f8f8"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://blog.plz.ac/posts/qubes_split-gpg/><link rel=prev href=https://blog.plz.ac/posts/cephadm-deploy/><link rel=next href=https://blog.plz.ac/posts/qubes-vpn-services/><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/color.css><link rel=stylesheet href=/css/style.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/fontawesome-free/all.min.css><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/animate/animate.min.css><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Qubes使用split GPG","inLanguage":"en-us","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.plz.ac\/posts\/qubes_split-gpg\/"},"genre":"posts","keywords":"Linux, Qubes, Security, GPG, Yubikey","wordcount":372,"url":"https:\/\/blog.plz.ac\/posts\/qubes_split-gpg\/","datePublished":"2024-03-23T12:17:45-04:00","dateModified":"2024-03-23T12:17:45-04:00","publisher":{"@type":"Organization","name":"Chris Su"},"author":{"@type":"Person","name":"Chris Su"},"description":"Qubes使用split GPG"}</script><script src=//instant.page/5.2.0 defer type=module integrity=sha384-jnZyxPjiipYXnSU0ygqeac2q7CVYMbh84q0uHVRRxEtvFPiQYbXWUorga2aqZJ0z></script></head><body header-desktop header-mobile><script type=text/javascript>function setTheme(e){document.body.setAttribute("theme",e),document.documentElement.style.setProperty("color-scheme",e==="light"?"light":"dark"),window.theme=e,window.isDark=window.theme!=="light"}function saveTheme(e){window.localStorage&&localStorage.setItem("theme",e)}function getMeta(e){const t=document.getElementsByTagName("meta");for(let n=0;n<t.length;n++)if(t[n].getAttribute("name")===e)return t[n];return""}if(window.localStorage&&localStorage.getItem("theme")){let e=localStorage.getItem("theme");e==="light"||e==="dark"||e==="black"?setTheme(e):setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")}else"auto"==="light"||"auto"==="dark"||"auto"==="black"?(setTheme("auto"),saveTheme("auto")):(saveTheme("auto"),setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"));let metaColors={light:"#f8f8f8",dark:"#252627",black:"#000000"};getMeta("theme-color").content=metaColors[document.body.getAttribute("theme")],window.switchThemeEventSet=new Set</script><div id=back-to-top></div><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=Power!>Power!</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/store/>商店 </a><a class=menu-item href=/philanthropy/>慈善 </a><a class=menu-item href=/links/>友链 </a><a class=menu-item href=/about/>关于 </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=Power!>Power!</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/ title>文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/store/ title>商店</a><a class=menu-item href=/philanthropy/ title>慈善</a><a class=menu-item href=/links/ title>友链</a><a class=menu-item href=/about/ title>关于</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto><nav id=TableOfContents><ul><li><a href=#环境配置>环境配置</a></li><li><a href=#git>Git</a></li><li><a href=#split-ssh>Split SSH</a></li><li><a href=#邮件加密>邮件加密</a></li><li><a href=#pass-with-split-gpg>pass with split gpg</a></li><li><a href=#todo>TODO</a></li><li><a href=#参考文档>参考文档</a></li></ul></nav></div></div><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC","true")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Qubes使用split GPG</h1><div class=post-meta><div class=post-meta-line><span class=post-author><span class="author fas fa-user-circle fa-fw"></span><a href=https://github.com/slchris title=Author target=_blank rel="noopener noreferrer author" class=author>Chris Su</a>
</span>&nbsp;<span class=post-category>included in </span>&nbsp;<span class=post-category>categories <a href=/categories/qubes/><i class="far fa-folder fa-fw"></i>Qubes</a>&nbsp;<a href=/categories/gpg/><i class="far fa-folder fa-fw"></i>GPG</a>&nbsp;<a href=/categories/security/><i class="far fa-folder fa-fw"></i>Security</a>&nbsp;<a href=/categories/linux/><i class="far fa-folder fa-fw"></i>Linux</a>&nbsp;<a href=/categories/privacy/><i class="far fa-folder fa-fw"></i>Privacy</a>&nbsp;<a href=/categories/yubikey/><i class="far fa-folder fa-fw"></i>Yubikey</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2024-03-23>2024-03-23</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime=2024-03-23>2024-03-23</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;372 words&nbsp;<i class="far fa-clock fa-fw"></i>&nbsp;2 minutes&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#环境配置>环境配置</a></li><li><a href=#git>Git</a></li><li><a href=#split-ssh>Split SSH</a></li><li><a href=#邮件加密>邮件加密</a></li><li><a href=#pass-with-split-gpg>pass with split gpg</a></li><li><a href=#todo>TODO</a></li><li><a href=#参考文档>参考文档</a></li></ul></nav></div></div><div class=content id=content><p>这篇文章记录一下如何使用Qubes的Split功能去做gpg的安全隔离的操作还有那些坑。</p><p>Split GPG 实现了类似于使用智能卡管理私有 GPG 密钥的概念，唯一不同的是，“智能卡”的角色由另一个 Qubes 应用 qube 扮演。这样一来，一个不太受信任的域，比如运行 Thunderbird 的域，可以将所有加密/解密和签名等加密操作委托给另一个更可信、网络隔离的域。这样一来，使用的域（比如运行 Thunderbird 或其他客户端应用的域）被入侵的情况——尽管这种情况不太可能——也不会让攻击者自动窃取所有密钥。（在这里，我们应该明显地指出，私有密钥上经常使用的密码基本没有意义，因为攻击者可以轻松设置一个简单的后门，等待用户输入密码，然后窃取密钥。）</p><p>from：https://www.qubes-os.org/doc/split-gpg/</p><h2 id=环境配置 class=headerLink><a href=#%e7%8e%af%e5%a2%83%e9%85%8d%e7%bd%ae class=header-mark></a>环境配置</h2><p><a href=https://www.qubes-os.org/news/2023/12/18/qubes-os-4-2-0-has-been-released/ target=_blank rel="noopener noreferrer">Qubes OS 4.2</a></p><p>首先要去安装 gpg-split</p><blockquote><p>dom0</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo qubes-dom0-update qubes-gpg-split-dom0
</span></span></code></pre></div><p>对应GPG的AppVM的Template是要安装：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo apt install qubes-gpg-split
</span></span></code></pre></div><p>将自己的gpg key导入到对应的qube之后可以通过这条命令去查看：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>gpg -K
</span></span></code></pre></div><p>gpg qube上配置超时时间</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;export QUBES_GPG_AUTOACCEPT=86400&#34;</span> &gt;&gt; ~/.profile
</span></span></code></pre></div><p>配置客户端qube使用：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nb>export</span> <span class=nv>QUBES_GPG_DOMAIN</span><span class=o>=</span>work-gpg
</span></span><span class=line><span class=cl>qubes-gpg-client -K
</span></span></code></pre></div><p>如：</p><p><figure><a class=lightgallery href=../../images/qubes-gpg-client-k.png title=../../images/qubes-gpg-client-k.png data-thumbnail=../../images/qubes-gpg-client-k.png><img loading=lazy src=../../images/qubes-gpg-client-k.png srcset="../../images/qubes-gpg-client-k.png, ../../images/qubes-gpg-client-k.png 1.5x, ../../images/qubes-gpg-client-k.png 2x" sizes=auto alt=../../images/qubes-gpg-client-k.png></a></figure></p><p>修改自动化的配置，能够使得qube可以自动选择对应的gpg-split的qbe</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;work-gpg&#34;</span> &gt; /rw/config/gpg-split-domain
</span></span></code></pre></div><p>在dom0上修改qubes-rpc文件<code>/etc/qubes-rpc/policy/qubes.Gpg</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>work-email  work-gpg  allow
</span></span></code></pre></div><p>这里是允许 work-email这个qube去访问work-gpg这个qube。</p><p>需要注意的是gpg要没有设置密码，不然 Split GPG 没办法进行加密和解密。</p><p>如果你设置了密码可以通过这条命令来修改：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>gpg2 --edit-key &lt;key_id&gt;
</span></span><span class=line><span class=cl>passwd
</span></span></code></pre></div><p>设置一个空密码之后保存即可。</p><h2 id=git class=headerLink><a href=#git class=header-mark></a>Git</h2><p>git可以通过配置gpg的program来去使用split gpg的client，可以修改<code>~/.gitconfig</code>配额文件如下所示</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>[</span>user<span class=o>]</span>
</span></span><span class=line><span class=cl>	<span class=nv>email</span> <span class=o>=</span> chris@lesscrowds.org
</span></span><span class=line><span class=cl>	<span class=nv>name</span> <span class=o>=</span> Chris Su
</span></span><span class=line><span class=cl>	<span class=nv>signingkey</span> <span class=o>=</span> 0x45D10727855239D3
</span></span><span class=line><span class=cl><span class=o>[</span>gpg<span class=o>]</span>
</span></span><span class=line><span class=cl>	<span class=nv>program</span> <span class=o>=</span> qubes-gpg-client-wrapper
</span></span><span class=line><span class=cl><span class=o>[</span>commit<span class=o>]</span>
</span></span><span class=line><span class=cl>	<span class=nv>gpgSign</span> <span class=o>=</span> <span class=m>1</span>
</span></span></code></pre></div><p>这里的signingkey是需要可以<code>qubes-gpg-client --list-keys</code>命令能够看到的。</p><p>可以本地搞个仓库生成一个commit看看：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>git init demo
</span></span><span class=line><span class=cl><span class=nb>cd</span> demo
</span></span><span class=line><span class=cl><span class=nb>echo</span> demo &gt; readme.md
</span></span><span class=line><span class=cl>git add .
</span></span><span class=line><span class=cl>git commit -s -m <span class=s2>&#34;add readme.md&#34;</span>
</span></span></code></pre></div><p>在commit的时候会有提示：</p><p><figure><a class=lightgallery href=../../images/qubes-split-gpg.png title=../../images/qubes-split-gpg.png data-thumbnail=../../images/qubes-split-gpg.png><img loading=lazy src=../../images/qubes-split-gpg.png srcset="../../images/qubes-split-gpg.png, ../../images/qubes-split-gpg.png 1.5x, ../../images/qubes-split-gpg.png 2x" sizes=auto alt=../../images/qubes-split-gpg.png></a></figure></p><p>查看对应的commit信息：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>git log --show-signature
</span></span></code></pre></div><p><figure><a class=lightgallery href=../../images/git-gpg-sing-log.png title=../../images/git-gpg-sing-log.png data-thumbnail=../../images/git-gpg-sing-log.png><img loading=lazy src=../../images/git-gpg-sing-log.png srcset="../../images/git-gpg-sing-log.png, ../../images/git-gpg-sing-log.png 1.5x, ../../images/git-gpg-sing-log.png 2x" sizes=auto alt=../../images/git-gpg-sing-log.png></a></figure></p><h2 id=split-ssh class=headerLink><a href=#split-ssh class=header-mark></a>Split SSH</h2><p>首先要在dom0里面去创建一个rpc文件</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>vi /etc/qubes-rpc/policy/qubes.SshAgent
</span></span></code></pre></div><p>内容如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>slchris-project slchris-gpg ask,default_target<span class=o>=</span>slchris-gpg
</span></span></code></pre></div><p>如果说不想要频繁的ask可以使用如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>slchris-project slchris-gpg allow,target<span class=o>=</span>slchris-gpg
</span></span></code></pre></div><p>在 slchris-gpg 这个AppVM里面去给gpg加上ssh的支持</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>vi ~/.gnupg/gpg-agent.conf
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>enable-ssh-support <span class=c1># 添加ssh的支持</span>
</span></span></code></pre></div><p>拿到ssh的keygrip</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>gpg --with-keygrip -k
</span></span></code></pre></div><p><figure><a class=lightgallery href=../../images/gpg-ssh-keygrip.png title=../../images/gpg-ssh-keygrip.png data-thumbnail=../../images/gpg-ssh-keygrip.png><img loading=lazy src=../../images/gpg-ssh-keygrip.png srcset="../../images/gpg-ssh-keygrip.png, ../../images/gpg-ssh-keygrip.png 1.5x, ../../images/gpg-ssh-keygrip.png 2x" sizes=auto alt=../../images/gpg-ssh-keygrip.png></a></figure></p><p>将其添加到<code>~/.gnupg/sshcontrol</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>9501B4272C70680B802F5F2F2D903AC2DE3C0525
</span></span></code></pre></div><p>在slchris-gpg的模板节点上创建<code>/etc/qubes-rpc/qubes.SshAgent</code>rpc文件内容如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=cp>#!/bin/sh
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1># Qubes App Split SSH Script</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Activate GPG Agent and set the correct SSH socket</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>SSH_AUTH_SOCK</span><span class=o>=</span><span class=k>$(</span>gpgconf --list-dirs agent-ssh-socket<span class=k>)</span>
</span></span><span class=line><span class=cl>gpgconf --launch gpg-agent
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># safeguard - Qubes notification bubble for each ssh request</span>
</span></span><span class=line><span class=cl>notify-send <span class=s2>&#34;[</span><span class=k>$(</span>qubesdb-read /name<span class=k>)</span><span class=s2>] SSH agent access from: </span><span class=nv>$QREXEC_REMOTE_DOMAIN</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># SSH connection</span>
</span></span><span class=line><span class=cl>socat - <span class=s2>&#34;UNIX-CONNECT:</span><span class=nv>$SSH_AUTH_SOCK</span><span class=s2>&#34;</span>
</span></span></code></pre></div><p>添加权限：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo chmod +x /etc/qubes-rpc/qubes.SshAgent
</span></span></code></pre></div><p>在slchris-project这个AppVM里面创建文件如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo vi /rw/config/rc.local
</span></span></code></pre></div><p>内容如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># SPLIT SSH CONFIGURATION &gt;&gt;&gt;</span>
</span></span><span class=line><span class=cl><span class=c1># replace &#34;slchris-gpg&#34; with your AppVM name which stores the ssh private key(s)</span>
</span></span><span class=line><span class=cl><span class=nv>SSH_VAULT_VM</span><span class=o>=</span><span class=s2>&#34;slchris-gpg&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$SSH_VAULT_VM</span><span class=s2>&#34;</span> !<span class=o>=</span> <span class=s2>&#34;&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>export</span> <span class=nv>SSH_SOCK</span><span class=o>=</span><span class=s2>&#34;/home/user/.SSH_AGENT_</span><span class=nv>$SSH_VAULT_VM</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  rm -f <span class=s2>&#34;</span><span class=nv>$SSH_SOCK</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  sudo -u user /bin/sh -c <span class=s2>&#34;umask 177 &amp;&amp; exec socat &#39;UNIX-LISTEN:</span><span class=nv>$SSH_SOCK</span><span class=s2>,fork&#39; &#39;EXEC:qrexec-client-vm </span><span class=nv>$SSH_VAULT_VM</span><span class=s2> qubes.SshAgent&#39;&#34;</span> <span class=p>&amp;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=c1># &lt;&lt;&lt; SPLIT SSH CONFIGURATION</span>
</span></span></code></pre></div><p>添加内容到<code>~/.bashrc</code>，内容如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># SPLIT SSH CONFIGURATION &gt;&gt;&gt;</span>
</span></span><span class=line><span class=cl><span class=c1># replace &#34;vault&#34; with your AppVM name which stores the ssh private key(s)</span>
</span></span><span class=line><span class=cl><span class=nv>SSH_VAULT_VM</span><span class=o>=</span><span class=s2>&#34;vault&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$SSH_VAULT_VM</span><span class=s2>&#34;</span> !<span class=o>=</span> <span class=s2>&#34;&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>export</span> <span class=nv>SSH_AUTH_SOCK</span><span class=o>=</span><span class=s2>&#34;/home/user/.SSH_AGENT_</span><span class=nv>$SSH_VAULT_VM</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=c1># &lt;&lt;&lt; SPLIT SSH CONFIGURATION</span>
</span></span></code></pre></div><p>重启slchris-project 然后使用</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>ssh-add -L
</span></span></code></pre></div><p>在执行的时候会出现询问是否可以访问slchris-gpg：</p><p><figure><a class=lightgallery href=../../images/gpg-split-ssh-ask.png title=../../images/gpg-split-ssh-ask.png data-thumbnail=../../images/gpg-split-ssh-ask.png><img loading=lazy src=../../images/gpg-split-ssh-ask.png srcset="../../images/gpg-split-ssh-ask.png, ../../images/gpg-split-ssh-ask.png 1.5x, ../../images/gpg-split-ssh-ask.png 2x" sizes=auto alt=../../images/gpg-split-ssh-ask.png></a></figure></p><p>允许之后便可正常输出。</p><h2 id=邮件加密 class=headerLink><a href=#%e9%82%ae%e4%bb%b6%e5%8a%a0%e5%af%86 class=header-mark></a>邮件加密</h2><p>这里用的是雷鸟客户端，78之后就不用再去安装插件了内置了gpg。</p><p><figure><a class=lightgallery href=../../images/th-mail-config.png title=../../images/th-mail-config.png data-thumbnail=../../images/th-mail-config.png><img loading=lazy src=../../images/th-mail-config.png srcset="../../images/th-mail-config.png, ../../images/th-mail-config.png 1.5x, ../../images/th-mail-config.png 2x" sizes=auto alt=../../images/th-mail-config.png></a></figure>选择config edit
在这里去搜索<code>mail.openpgp.allow_external_gnupg</code>将其打开</p><p>再去搜索 <code>mail.openpgp.alternative_gpg_path</code> 设置其值为<code>/usr/bin/qubes-gpg-client-wrapper</code> 然后去重启雷鸟客户端。</p><p>重启之后在邮件账户配置中修改End To End加密这部分的配置</p><p><figure><a class=lightgallery href=../../images/th-mail-add-key.png title=../../images/th-mail-add-key.png data-thumbnail=../../images/th-mail-add-key.png><img loading=lazy src=../../images/th-mail-add-key.png srcset="../../images/th-mail-add-key.png, ../../images/th-mail-add-key.png 1.5x, ../../images/th-mail-add-key.png 2x" sizes=auto alt=../../images/th-mail-add-key.png></a></figure></p><p>这里要注意选择用smartcard设备：</p><p><figure><a class=lightgallery href=../../images/th-mail-add-key-use-smartcard.png title=../../images/th-mail-add-key-use-smartcard.png data-thumbnail=../../images/th-mail-add-key-use-smartcard.png><img loading=lazy src=../../images/th-mail-add-key-use-smartcard.png srcset="../../images/th-mail-add-key-use-smartcard.png, ../../images/th-mail-add-key-use-smartcard.png 1.5x, ../../images/th-mail-add-key-use-smartcard.png 2x" sizes=auto alt=../../images/th-mail-add-key-use-smartcard.png></a></figure></p><p>这里要填写gpg的keyid，keyid可以使用这条命令来获得：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>qubes-gpg-client-wrapper -K --keyid-format long
</span></span></code></pre></div><p><figure><a class=lightgallery href=../../images/th-mail-add-key-use-smartcard-id.png title=../../images/th-mail-add-key-use-smartcard-id.png data-thumbnail=../../images/th-mail-add-key-use-smartcard-id.png><img loading=lazy src=../../images/th-mail-add-key-use-smartcard-id.png srcset="../../images/th-mail-add-key-use-smartcard-id.png, ../../images/th-mail-add-key-use-smartcard-id.png 1.5x, ../../images/th-mail-add-key-use-smartcard-id.png 2x" sizes=auto alt=../../images/th-mail-add-key-use-smartcard-id.png></a></figure></p><p>添加完成后如下所示：</p><p><figure><a class=lightgallery href=../../images/th-mail-add-key-done.png title=../../images/th-mail-add-key-done.png data-thumbnail=../../images/th-mail-add-key-done.png><img loading=lazy src=../../images/th-mail-add-key-done.png srcset="../../images/th-mail-add-key-done.png, ../../images/th-mail-add-key-done.png 1.5x, ../../images/th-mail-add-key-done.png 2x" sizes=auto alt=../../images/th-mail-add-key-done.png></a></figure></p><p>因为雷鸟客户端是没办法从<code>/usr/bin/qubes-gpg-client-wrapper</code>拿到公钥的我们还需要自己手动导入一下：</p><p><figure><a class=lightgallery href=../../images/th-mail-add-pub-key.png title=../../images/th-mail-add-pub-key.png data-thumbnail=../../images/th-mail-add-pub-key.png><img loading=lazy src=../../images/th-mail-add-pub-key.png srcset="../../images/th-mail-add-pub-key.png, ../../images/th-mail-add-pub-key.png 1.5x, ../../images/th-mail-add-pub-key.png 2x" sizes=auto alt=../../images/th-mail-add-pub-key.png></a></figure></p><p>要选择信任的等级，这个必须要选择<code>Yes, I’ve verified in person this key has the correct fingerprint.</code> 信任自己的指纹:</p><p><figure><a class=lightgallery href=../../images/th-mail-trust-pub-key.png title=../../images/th-mail-trust-pub-key.png data-thumbnail=../../images/th-mail-trust-pub-key.png><img loading=lazy src=../../images/th-mail-trust-pub-key.png srcset="../../images/th-mail-trust-pub-key.png, ../../images/th-mail-trust-pub-key.png 1.5x, ../../images/th-mail-trust-pub-key.png 2x" sizes=auto alt=../../images/th-mail-trust-pub-key.png></a></figure></p><blockquote><p>测试</p></blockquote><p>可以给自己写一封邮件来测试：</p><p><figure><a class=lightgallery href=../../images/th-mail-send-mail-test.png title=../../images/th-mail-send-mail-test.png data-thumbnail=../../images/th-mail-send-mail-test.png><img loading=lazy src=../../images/th-mail-send-mail-test.png srcset="../../images/th-mail-send-mail-test.png, ../../images/th-mail-send-mail-test.png 1.5x, ../../images/th-mail-send-mail-test.png 2x" sizes=auto alt=../../images/th-mail-send-mail-test.png></a></figure>这里可以看到加密的选项已经被打开了</p><p>发送的时候也会提示输入yubikey的pin：</p><p><figure><a class=lightgallery href=../../images/th-mail-send-ask.png title=../../images/th-mail-send-ask.png data-thumbnail=../../images/th-mail-send-ask.png><img loading=lazy src=../../images/th-mail-send-ask.png srcset="../../images/th-mail-send-ask.png, ../../images/th-mail-send-ask.png 1.5x, ../../images/th-mail-send-ask.png 2x" sizes=auto alt=../../images/th-mail-send-ask.png></a></figure></p><p>收到查看的时候也会提示要输入pin，输入之后就可以查看到解密后的邮件内容：</p><p><figure><a class=lightgallery href=../../images/th-mail-view-mail.png title=../../images/th-mail-view-mail.png data-thumbnail=../../images/th-mail-view-mail.png><img loading=lazy src=../../images/th-mail-view-mail.png srcset="../../images/th-mail-view-mail.png, ../../images/th-mail-view-mail.png 1.5x, ../../images/th-mail-view-mail.png 2x" sizes=auto alt=../../images/th-mail-view-mail.png></a></figure></p><h2 id=pass-with-split-gpg class=headerLink><a href=#pass-with-split-gpg class=header-mark></a>pass with split gpg</h2><p>默认pass是不支持split的，但是可以通过扩展功能使其支持gpg，有大佬已经写好这个插件可以直接用了下载这个<a href=https://github.com/kulinacs/pass-qubes target=_blank rel="noopener noreferrer">qubes.bash</a>文件。</p><p>首先创建插件的文件夹：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>mkdir -p ~/.password-store/.extensions
</span></span><span class=line><span class=cl>mv ~Downloads/qubes.bash ~/.password-store/.extensions/
</span></span><span class=line><span class=cl>chmod +x ~/.password-store/.extensions/*.bash
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>PASSWORD_STORE_ENABLE_EXTENSIONS</span><span class=o>=</span><span class=nb>true</span>
</span></span></code></pre></div><p>这样就可以使用了，比如说：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>pass qubes generate -c -n test/t0 <span class=m>128</span>
</span></span><span class=line><span class=cl>pass qubes show test/t0 --clip
</span></span><span class=line><span class=cl>pass qubes rm test/t0 
</span></span></code></pre></div><p>这个插件默认打开可以丢在<code>~/.profile</code> 里面：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;export PASSWORD_STORE_ENABLE_EXTENSIONS=true&#34;</span> &gt;&gt; ~/.profile
</span></span></code></pre></div><h2 id=todo class=headerLink><a href=#todo class=header-mark></a>TODO</h2><ul><li><i class="far fa-square fa-fw"></i> 使用自动化工具批量配置split</li></ul><h2 id=参考文档 class=headerLink><a href=#%e5%8f%82%e8%80%83%e6%96%87%e6%a1%a3 class=header-mark></a>参考文档</h2><p><a href="https://github.com/drduh/YubiKey-Guide?tab=readme-ov-file#using-yubikey" target=_blank rel="noopener noreferrer">https://github.com/drduh/YubiKey-Guide?tab=readme-ov-file#using-yubikey</a>
<a href=https://privsec.dev/posts/qubes/using-split-gpg-and-split-ssh-on-qubes-os/ target=_blank rel="noopener noreferrer">https://privsec.dev/posts/qubes/using-split-gpg-and-split-ssh-on-qubes-os/</a></p></div><div class=sponsor><div class=sponsor-avatar><img loading=lazy src=/images/chris.jpg srcset="/images/chris.jpg, /images/chris.jpg 1.5x, /images/chris.jpg 2x" sizes=auto alt=/images/chris.jpg title=/images/chris.jpg></div><p class=sponsor-bio><em>如果你觉得这篇文章对你有所帮助，欢迎赞赏~</em></p><a href=https://www.buymeacoffee.com/slchris title=Sponsor target=_blank class=sponsor-button rel="noopener noreferrer"><i class="far fa-heart fa-fw icon" style=color:#ec6cb9></i>
<span>Sponsor</span></a></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2024-03-23</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><button title="Share on Twitter" data-sharer=twitter data-url=https://blog.plz.ac/posts/qubes_split-gpg/ data-title="Qubes使用split GPG" data-hashtags=Linux,Qubes,Security,GPG,Yubikey><span class="fab fa-twitter fa-fw"></span></button><button title="Share on Facebook" data-sharer=facebook data-url=https://blog.plz.ac/posts/qubes_split-gpg/ data-hashtag=Linux><span class="fab fa-facebook-square fa-fw"></span></button><button title="Share on Linkedin" data-sharer=linkedin data-url=https://blog.plz.ac/posts/qubes_split-gpg/><span class="fab fa-linkedin fa-fw"></span></button><button title="Share on WhatsApp" data-sharer=whatsapp data-url=https://blog.plz.ac/posts/qubes_split-gpg/ data-title="Qubes使用split GPG" data-web><span class="fab fa-whatsapp fa-fw"></span></button><button title="Share on Reddit" data-sharer=reddit data-url=https://blog.plz.ac/posts/qubes_split-gpg/><span class="fab fa-reddit fa-fw"></span></button><button title="Share on Line" data-sharer=line data-url=https://blog.plz.ac/posts/qubes_split-gpg/ data-title="Qubes使用split GPG"><span data-svg-src=/lib/simple-icons/icons/line.min.svg></span></button><button title="Share on Blogger" data-sharer=blogger data-url=https://blog.plz.ac/posts/qubes_split-gpg/ data-title="Qubes使用split GPG" data-description="Qubes使用split GPG"><span class="fab fa-blogger fa-fw"></span></button><button title="Share on Evernote" data-sharer=evernote data-url=https://blog.plz.ac/posts/qubes_split-gpg/ data-title="Qubes使用split GPG"><span class="fab fa-evernote fa-fw"></span></button><button title="Share on Trello" data-sharer=trello data-url=https://blog.plz.ac/posts/qubes_split-gpg/ data-title="Qubes使用split GPG" data-description="Qubes使用split GPG"><span class="fab fa-trello fa-fw"></span></button><script>function shareOnMastodon(e,t){const o="share_mastodon_domain",i=localStorage.getItem(o)??"mastodon.social",n=prompt("Enter your Mastodon domain",i);if(n===null)return;localStorage.setItem(o,n);const a=e+`

`+t,s=new URL("https://"+n);s.pathname="share",s.searchParams.append("text",a),window.open(s,"_blank","width=500,height=500,left=500,toolbar=0,status=0")}</script>
<button title="Share on Mastodon" onclick='shareOnMastodon("Qubes使用split GPG","https://blog.plz.ac/posts/qubes_split-gpg/")'><span class="fab fa-mastodon fa-fw"></span></button></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/linux/>Linux</a>,&nbsp;<a href=/tags/qubes/>Qubes</a>,&nbsp;<a href=/tags/security/>Security</a>,&nbsp;<a href=/tags/gpg/>GPG</a>,&nbsp;<a href=/tags/yubikey/>Yubikey</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/cephadm-deploy/ class=prev rel=prev title="cephadm 部署ceph集群"><i class="fas fa-angle-left fa-fw"></i>cephadm 部署ceph集群</a>
<a href=/posts/qubes-vpn-services/ class=next rel=next title=Qubes上使用VPN服务>Qubes上使用VPN服务<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=utterances></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>Utterances</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreferrer" title="Hugo 0.110.0">Hugo</a>&nbsp;|&nbsp;Theme - <a href=https://github.com/HEIGE-PCloud/DoIt target=_blank rel="noopener noreferrer" title="DoIt 0.4.0"><i class="far fa-edit fa-fw"></i> DoIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2023 - 2025</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://github.com/slchris target=_blank rel="noopener noreferrer">Chris Su</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class=footer-line></div><div class=footer-line></div></div><script>"serviceWorker"in navigator&&(navigator.serviceWorker.register("/sw.min.js",{scope:"/"}).then(function(){}),navigator.serviceWorker.ready.then(function(){}))</script></footer></div><div id=fixed-buttons><a href=#back-to-top id=back-to-top-button class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw"></i></a></div><div class=assets><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/katex/copy-tex.min.css><noscript><link rel=stylesheet href=/lib/katex/copy-tex.min.css></noscript><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:10},comment:{utterances:{darkTheme:"github-dark",issueTerm:"pathname",label:"",lightTheme:"github-light",repo:"slchris/blog.plz.ac-comments"}},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},sharerjs:!0,table:{sort:!0}}</script><script type=text/javascript src=/lib/tablesort/tablesort.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js defer></script><script type=text/javascript src=/lib/katex/auto-render.min.js defer></script><script type=text/javascript src=/lib/katex/copy-tex.min.js defer></script><script type=text/javascript src=/lib/katex/mhchem.min.js defer></script><script type=text/javascript src=/js/katex.min.js defer></script><script type=text/javascript src=/js/theme.min.js defer></script><script type=text/javascript src=/js/utterances.min.js defer></script></div></body></html>