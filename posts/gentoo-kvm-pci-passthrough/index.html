<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Gentoo PCI KVM设备直通 - Power!</title><meta name=Description content="Gentoo Riscv Keyword"><meta property="og:title" content="Gentoo PCI KVM设备直通"><meta property="og:description" content="Gentoo Riscv Keyword"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.plz.ac/posts/gentoo-kvm-pci-passthrough/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-03-28T11:39:26-04:00"><meta property="article:modified_time" content="2024-03-28T11:39:26-04:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Gentoo PCI KVM设备直通"><meta name=twitter:description content="Gentoo Riscv Keyword"><meta name=application-name content="Power!"><meta name=apple-mobile-web-app-title content="Power!"><meta name=theme-color content="#f8f8f8"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://blog.plz.ac/posts/gentoo-kvm-pci-passthrough/><link rel=prev href=https://blog.plz.ac/posts/gentoo-rpi4/><link rel=next href=https://blog.plz.ac/posts/mysql-mm/><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/color.css><link rel=stylesheet href=/css/style.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/fontawesome-free/all.min.css><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/animate/animate.min.css><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Gentoo PCI KVM设备直通","inLanguage":"en-us","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.plz.ac\/posts\/gentoo-kvm-pci-passthrough\/"},"genre":"posts","keywords":"Linux, Gentoo, KVM, QEMU, Passthrough","wordcount":881,"url":"https:\/\/blog.plz.ac\/posts\/gentoo-kvm-pci-passthrough\/","datePublished":"2024-03-28T11:39:26-04:00","dateModified":"2024-03-28T11:39:26-04:00","publisher":{"@type":"Organization","name":"Chris Su"},"author":{"@type":"Person","name":"Chris Su"},"description":"Gentoo Riscv Keyword"}</script><script src=//instant.page/5.2.0 defer type=module integrity=sha384-jnZyxPjiipYXnSU0ygqeac2q7CVYMbh84q0uHVRRxEtvFPiQYbXWUorga2aqZJ0z></script></head><body header-desktop header-mobile><script type=text/javascript>function setTheme(e){document.body.setAttribute("theme",e),document.documentElement.style.setProperty("color-scheme",e==="light"?"light":"dark"),window.theme=e,window.isDark=window.theme!=="light"}function saveTheme(e){window.localStorage&&localStorage.setItem("theme",e)}function getMeta(e){const t=document.getElementsByTagName("meta");for(let n=0;n<t.length;n++)if(t[n].getAttribute("name")===e)return t[n];return""}if(window.localStorage&&localStorage.getItem("theme")){let e=localStorage.getItem("theme");e==="light"||e==="dark"||e==="black"?setTheme(e):setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")}else"auto"==="light"||"auto"==="dark"||"auto"==="black"?(setTheme("auto"),saveTheme("auto")):(saveTheme("auto"),setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"));let metaColors={light:"#f8f8f8",dark:"#252627",black:"#000000"};getMeta("theme-color").content=metaColors[document.body.getAttribute("theme")],window.switchThemeEventSet=new Set</script><div id=back-to-top></div><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=Power!>Power!</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/posts/>文章 </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=Power!>Power!</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/posts/ title>文章</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto><nav id=TableOfContents><ul><li><a href=#环境说明>环境说明</a></li><li><a href=#环境准备>环境准备</a><ul><li><a href=#部署kvm>部署KVM</a></li><li><a href=#配置libvirt>配置libvirt</a></li><li><a href=#配置桥接网络>配置桥接网络</a></li><li><a href=#在宿主启动iommu>在宿主启动iommu</a></li><li><a href=#在宿主机系统中预留设备>在宿主机系统中预留设备</a></li></ul></li><li><a href=#部署虚拟机>部署虚拟机</a><ul><li><a href=#添加pci设备>添加PCI设备</a></li></ul></li></ul></nav></div></div><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC","true")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Gentoo PCI KVM设备直通</h1><div class=post-meta><div class=post-meta-line><span class=post-author><span class="author fas fa-user-circle fa-fw"></span><a href=https://blog.plz.ac title=Author target=_blank rel="noopener noreferrer author" class=author>Chris Su</a>
</span>&nbsp;<span class=post-category>included in </span>&nbsp;<span class=post-category>categories <a href=/categories/gentoo/><i class="far fa-folder fa-fw"></i>Gentoo</a>&nbsp;<a href=/categories/qemu/><i class="far fa-folder fa-fw"></i>QEMU</a>&nbsp;<a href=/categories/linux/><i class="far fa-folder fa-fw"></i>Linux</a>&nbsp;<a href=/categories/passthrough/><i class="far fa-folder fa-fw"></i>Passthrough</a>&nbsp;<a href=/categories/kvm/><i class="far fa-folder fa-fw"></i>KVM</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2024-03-28>2024-03-28</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime=2024-03-28>2024-03-28</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;881 words&nbsp;<i class="far fa-clock fa-fw"></i>&nbsp;5 minutes&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#环境说明>环境说明</a></li><li><a href=#环境准备>环境准备</a><ul><li><a href=#部署kvm>部署KVM</a></li><li><a href=#配置libvirt>配置libvirt</a></li><li><a href=#配置桥接网络>配置桥接网络</a></li><li><a href=#在宿主启动iommu>在宿主启动iommu</a></li><li><a href=#在宿主机系统中预留设备>在宿主机系统中预留设备</a></li></ul></li><li><a href=#部署虚拟机>部署虚拟机</a><ul><li><a href=#添加pci设备>添加PCI设备</a></li></ul></li></ul></nav></div></div><div class=content id=content><p>这篇是一篇如何在Gentoo下面做KVM直通的文章，取自之前的笔记中。</p><p>最近手里面的电脑送的差不多了，现在手边只有一个Mac 和一个工作站了。平时那个Mac太重了也不太想要背（画画也不是很舒服，画画的时候噪音挺大的），看了手边的工作站pcie槽位还挺多cpu的通道数也足够，于是打算折腾一下KVM PCI设备直通，通过PCI设备直通将一张显卡分配给虚拟机还有音频USB之类的周边设备从而达到想要的效果（画画摸鱼机！）。</p><h2 id=环境说明 class=headerLink><a href=#%e7%8e%af%e5%a2%83%e8%af%b4%e6%98%8e class=header-mark></a>环境说明</h2><p>这里先说明一下环境以及如何分配这些资源。
我的工作站是一个非常年迈的ThinkStation S20 ，配置如下</p><table><thead><tr><th>型号</th><th>CPU</th><th>内存</th><th>硬盘</th><th>显卡</th><th>USB扩展卡</th><th>声卡</th></tr></thead><tbody><tr><td>ThinkStation S20</td><td>X5670</td><td>8G * 3</td><td>PCIE SSD 800G 500G * 1 12TB *2</td><td>GT 620 Quadro K2000</td><td>不知名的PCI 2.0 扩展卡</td><td>SB CA10300 和板载声卡</td></tr></tbody></table><p>以上的硬件是符合这次的PCI设备直通的基本要求。如果你也想要尝试做PCI设备直通请确保你的硬件满足以下特性。</p><ul><li>CPU 支持VT-d (intel) amd-vi(amd)</li><li>两张显卡（如果你的CPU带有核心显卡同时主板支持核心显卡输出那么你只需要一张就足够了，如果不支持就需要2张独立显卡）</li><li>iommu支持 （iommu负责把主板上的设备分组，我们等下就是要在宿主机上遮盖掉要给虚拟机分配设备的组）</li></ul><p>这次打算是创建一个Windows虚拟机将K2000和SB声卡以及PCI 2.0的扩展卡直通到这个虚拟机，作为日常画画用的节点。（或者是后续换成Mac虚拟机）。
磁盘分配是打算分配200G的SSD空间给这个虚拟机其余以网络磁盘方式分配给虚拟机。</p><h2 id=环境准备 class=headerLink><a href=#%e7%8e%af%e5%a2%83%e5%87%86%e5%a4%87 class=header-mark></a>环境准备</h2><p>这里准备一下创建虚拟机的准备比如说KVM环境安装镜像 etc.
宿主机系统我这里选择的是Gentoo</p><h3 id=部署kvm class=headerLink><a href=#%e9%83%a8%e7%bd%b2kvm class=header-mark></a>部署KVM</h3><p>首先运行这条命令查看你的机器是否支持虚拟化</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>grep --color -E <span class=s2>&#34;vmx|svm&#34;</span> /proc/cpuinfo
</span></span></code></pre></div><p>如果没有类似以下的输出就需要检查一下BIOS中虚拟化的选项是否开启，或者是查看 Intel Ark 来查找你的CPU是否支持虚拟化。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>flags           : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ht tm pbe syscall nx pdpe1gb rdtscp lm constant_tsc arch_perfmon pebs bts rep_good nopl xtopology nonstop_tsc cpuid aperfmperf pni pclmulqdq dtes64 monitor ds_cpl vmx smx est tm2 ssse3 cx16 xtpr pdcm pcid dca sse4_1 sse4_2 popcnt aes lahf_lm epb pti tpr_shadow vnmi flexpriority ept vpid dtherm ida arat
</span></span></code></pre></div><p>确保你的内核以下选项打开</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Virtualization  ---&gt;
</span></span><span class=line><span class=cl>    &lt;*&gt;   Kernel-based Virtual Machine <span class=o>(</span>KVM<span class=o>)</span> support
</span></span></code></pre></div><p>如果你的是Intel 处理器请确保将以下选项编译为模块或者是包含在内核中</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Virtualization  ---&gt;
</span></span><span class=line><span class=cl>       KVM <span class=k>for</span> Intel processors support
</span></span></code></pre></div><p>如果你的是AMD 处理器请确保将以下选项编译为模块或者是包含在内核中</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Virtualization  ---&gt;
</span></span><span class=line><span class=cl>       KVM <span class=k>for</span> AMD processors support
</span></span></code></pre></div><p>我们这里在构建qemu的时候还需要开启 vhost-net的USE这里推荐打开以下内核选项</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Virtualization  ---&gt;
</span></span><span class=line><span class=cl>    &lt;*&gt;   Host kernel accelerator <span class=k>for</span> virtio net
</span></span></code></pre></div><p>对于高级网络的支持</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>Device Drivers  ---&gt;
</span></span><span class=line><span class=cl>    <span class=o>[</span>*<span class=o>]</span> Network device support  ---&gt;
</span></span><span class=line><span class=cl>        <span class=o>[</span>*<span class=o>]</span>   Network core driver support
</span></span><span class=line><span class=cl>        &lt;*&gt;   Universal TUN/TAP device driver support
</span></span></code></pre></div><p>这里打算使用的是桥接网络，所以还需要打开以下选项</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Networking support  ---&gt;
</span></span><span class=line><span class=cl>        Networking options  ---&gt;
</span></span><span class=line><span class=cl>            &lt;*&gt; The IPv6 protocol
</span></span><span class=line><span class=cl>            &lt;*&gt; 802.1d Ethernet Bridging
</span></span></code></pre></div><p>更改好这些内核选项后记得更新内核，再使用新的内核启动。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>make -j12 <span class=o>&amp;&amp;</span> make modules_install <span class=o>&amp;&amp;</span> make install <span class=o>&amp;&amp;</span> grub-mkconfig -o /boot/grub/grub.cfg <span class=o>&amp;&amp;</span> reboot
</span></span></code></pre></div><p>重启后，现在我们可以安装QEMU了，这里安装有两种不同的方式（添加我们需要的USE）。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nv>USE</span><span class=o>=</span><span class=s2>&#34;spice usb usbredir vhost-net&#34;</span> emerge qemu
</span></span></code></pre></div><p>或者是将这些USE写到一个文件中。
创建并编辑 <code>/etc/portage/package.use/qemu</code>,内容如下</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>app-emulation/qemu spice usb usbredir vhost-net
</span></span></code></pre></div><p>然后安装QEMU</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>emerge qemu
</span></span></code></pre></div><p>接下来我们需要部署一个管理虚拟机的工具包（libvirt）</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>emerge app-emulation/libvirt
</span></span></code></pre></div><p>启动 libvirt 并加入开启启动</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>/etc/init.d/libvirtd start
</span></span><span class=line><span class=cl>rc-update add libvirt default
</span></span></code></pre></div><p>网桥设置，我这里虚拟机需要和内网的其他服务器进行互通，所以这里选择的是桥接网络为了方便管理桥接网络这里还需要一个工具</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>emerge bridge-utils
</span></span></code></pre></div><p>同时为了让虚拟机支持UEFI这里还需要安装一个包用于支持虚拟机UEFI启动</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>emerge sys-firmware/edk2-ovmf
</span></span></code></pre></div><p>如果直接安装windows可能会找不到磁盘还需要一个包</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>emerge app-emulation/virtio-win
</span></span></code></pre></div><p>如果想要一个gui管理界面可以安装virt-manager：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>emerge virt-manager
</span></span></code></pre></div><h3 id=配置libvirt class=headerLink><a href=#%e9%85%8d%e7%bd%aelibvirt class=header-mark></a>配置libvirt</h3><p>为了能够安装有uefi支持的虚拟机还需要做一些配置。
编辑<code>/etc/libvirt/qemu.conf</code>添加以下内容:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nv>nvram</span> <span class=o>=</span> <span class=o>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;/usr/share/edk2-ovmf/OVMF_CODE.fd:/usr/share/edk2-ovmf/OVMF_VARS.fd&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;/usr/share/edk2-ovmf/OVMF_VARS.secboot.fd:/usr/share/edk2-ovmf/OVMF_VARS.fd&#34;</span>
</span></span><span class=line><span class=cl><span class=o>]</span>
</span></span></code></pre></div><p>修改<code>/usr/share/qemu/firmware/50-edk2-x86_64-secure.json</code>内容如下</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;description&#34;</span><span class=p>:</span> <span class=s2>&#34;UEFI firmware for x86_64, with Secure Boot and SMM&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;interface-types&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;uefi&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;mapping&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;device&#34;</span><span class=p>:</span> <span class=s2>&#34;flash&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;executable&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;filename&#34;</span><span class=p>:</span> <span class=s2>&#34;/usr/share/edk2-ovmf/OVMF_CODE.fd&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;format&#34;</span><span class=p>:</span> <span class=s2>&#34;raw&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;nvram-template&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;filename&#34;</span><span class=p>:</span> <span class=s2>&#34;/usr/share/edk2-ovmf/OVMF_VARS.fd&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;format&#34;</span><span class=p>:</span> <span class=s2>&#34;raw&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;targets&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;architecture&#34;</span><span class=p>:</span> <span class=s2>&#34;x86_64&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;machines&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;pc-q35-*&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;features&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;acpi-s3&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;amd-sev&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;requires-smm&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;secure-boot&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;verbose-dynamic&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;tags&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>重启libvirtd</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>/etc/init.d/libvirtd restart
</span></span></code></pre></div><h3 id=配置桥接网络 class=headerLink><a href=#%e9%85%8d%e7%bd%ae%e6%a1%a5%e6%8e%a5%e7%bd%91%e7%bb%9c class=header-mark></a>配置桥接网络</h3><p>配置网络有两种方式一种是用NetworkMnager去接管另一种是直接配置文件创建一个桥接网络，这里分别说明以下两种的配置方法。</p><ol><li>配置文件的方法</li></ol><p>编辑 <code>/etc/conf.d/net</code>内容如下</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nv>bridge_br0</span><span class=o>=</span><span class=s2>&#34;enp6s0&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># 这个enp6s0 是我的物理网卡替换成你的</span>
</span></span><span class=line><span class=cl><span class=c1># Bridge static config</span>
</span></span><span class=line><span class=cl><span class=nv>config_br0</span><span class=o>=</span><span class=s2>&#34;10.0.0.10 netmask 255.255.255.0&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>routes_br0</span><span class=o>=</span><span class=s2>&#34;default via 10.0.0.1&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>bridge_forward_delay_br0</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl><span class=nv>bridge_hello_time_br0</span><span class=o>=</span><span class=m>1000</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>bridge_stp_state_br0</span><span class=o>=</span><span class=m>1</span>
</span></span></code></pre></div><p>创建一个软连接</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>ln -s /etc/init.d/net.lo /etc/init.d/net.br0
</span></span></code></pre></div><p>启动这个桥接网卡</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>rc-service net.br0 start
</span></span></code></pre></div><p>加入开机启动</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>rc-update add net.br0 default
</span></span></code></pre></div><p>验证</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>brctl show
</span></span><span class=line><span class=cl>bridge name     bridge id               STP enabled     interfaces
</span></span><span class=line><span class=cl>br0             8000.70f39503c843       yes             enp6s0
</span></span></code></pre></div><p>这样桥接网卡就配置好了</p><ol start=2><li>NetworkManager
首先创建一个网桥设备</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>nmcli con add <span class=nb>type</span> bridge ifname br0
</span></span></code></pre></div><p>添加一个bridge-slave的网卡</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>nmcli con add <span class=nb>type</span> bridge-slave ifname enp6s0 master br0
</span></span></code></pre></div><p>配置stp（防止桥回路）</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>nmcli con modify br0 bridge.stp yes
</span></span></code></pre></div><p>给br0 配置ip</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>nmcli con mod br0 ipv4.method manual ipv4.addresses <span class=s2>&#34;10.0.0.10/24&#34;</span> ipv4.gateway 10.0.0.1 ipv4.dns 114.114.114.114 connection.autoconnect yes
</span></span><span class=line><span class=cl>nmcli con up br0
</span></span></code></pre></div><p>验证</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>brctl show
</span></span><span class=line><span class=cl>bridge name     bridge id               STP enabled     interfaces
</span></span><span class=line><span class=cl>br0             8000.70f39503c843       yes             enp6s0
</span></span></code></pre></div><h3 id=在宿主启动iommu class=headerLink><a href=#%e5%9c%a8%e5%ae%bf%e4%b8%bb%e5%90%af%e5%8a%a8iommu class=header-mark></a>在宿主启动iommu</h3><p>在宿主机器启动iommu需要给内核一些启动参数就可以启用了
编辑 <code>/etc/default/grub</code>找到 <code>GRUB_CMDLINE_LINUX=</code>修改内容如下</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nv>GRUB_CMDLINE_LINUX</span><span class=o>=</span><span class=s2>&#34;iommu=pt intel_iommu=on pcie_acs_override=downstream,multifunction vfio_iommu_type1.allow_unsafe_interrupts=1
</span></span></span></code></pre></div><p>然后更新grub 并重启</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>grub-mkconfig -o /boot/grub/grub.cfg<span class=o>&amp;&amp;</span> reboot
</span></span></code></pre></div><p>开机后使用dmegs查看ring buffer中的信息</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>dmesg <span class=p>|</span> grep <span class=s1>&#39;IOMMU enabled&#39;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>    0.251621<span class=o>]</span> DMAR: IOMMU enabled
</span></span></code></pre></div><p>这里可以看到IOMMU已经启用了</p><h3 id=在宿主机系统中预留设备 class=headerLink><a href=#%e5%9c%a8%e5%ae%bf%e4%b8%bb%e6%9c%ba%e7%b3%bb%e7%bb%9f%e4%b8%ad%e9%a2%84%e7%95%99%e8%ae%be%e5%a4%87 class=header-mark></a>在宿主机系统中预留设备</h3><p>为了能够在宿主机上预留设备我们需要再对内核进行修改，这次用到的是VFIO(可以将设备IO，DMA给到用户态)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>Device Drivers ---&gt;
</span></span><span class=line><span class=cl>  &lt;*&gt; VFIO Non-Privileged userpsace driver framework ---&gt;
</span></span><span class=line><span class=cl>      <span class=o>[</span>*<span class=o>]</span>   VFIO No-IOMMU support ----
</span></span><span class=line><span class=cl>      &lt;*&gt;   VFIO support <span class=k>for</span> PCI devices
</span></span><span class=line><span class=cl>      <span class=o>[</span>*<span class=o>]</span>     VFIO PCI support <span class=k>for</span> VGA devices
</span></span><span class=line><span class=cl>      &lt; &gt;   Mediated device driver framework
</span></span></code></pre></div><p>这里的VFIO support for PCI devices看自己喜好去编译我这里直接内建在内核了，然后通过grub传参数。 然后构建新的内核</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>make -j12 <span class=o>&amp;&amp;</span> make modules_install <span class=o>&amp;&amp;</span> make install <span class=o>&amp;&amp;</span> grub-mkconfig -o /boot/grub/grub.cfg <span class=o>&amp;&amp;</span> reboot
</span></span></code></pre></div><p>重启后我们来找我们需要的设备
这里用一个脚本来快捷的找这些设备</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=nb>shopt</span> -s nullglob
</span></span><span class=line><span class=cl><span class=k>for</span> g in /sys/kernel/iommu_groups/*<span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;IOMMU Group </span><span class=si>${</span><span class=nv>g</span><span class=p>##*/</span><span class=si>}</span><span class=s2>:&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> d in <span class=nv>$g</span>/devices/*<span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> -e <span class=s2>&#34;\t</span><span class=k>$(</span>lspci -nns <span class=si>${</span><span class=nv>d</span><span class=p>##*/</span><span class=si>}</span><span class=k>)</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>done</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>done</span><span class=p>;</span>
</span></span></code></pre></div><p>保存到文件并运行，我们从输出中找到需要的信息并记录下来
这里是一个声卡的组可以看到这个声卡是单独放在一组的我们记住最后的两段数字和字母的组合8086:3a3e</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>IOMMU Group 16:
</span></span><span class=line><span class=cl>        00:1b.0 Audio device <span class=o>[</span>0403<span class=o>]</span>: Intel Corporation 82801JI <span class=o>(</span>ICH10 Family<span class=o>)</span> HD Audio Controller <span class=o>[</span>8086:3a3e<span class=o>]</span>
</span></span></code></pre></div><p>接着往后看看到</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>IOMMU Group 17:
</span></span><span class=line><span class=cl>        00:1c.0 PCI bridge <span class=o>[</span>0604<span class=o>]</span>: Intel Corporation 82801JI <span class=o>(</span>ICH10 Family<span class=o>)</span> PCI Express Root Port <span class=m>1</span> <span class=o>[</span>8086:3a40<span class=o>]</span>
</span></span><span class=line><span class=cl>        00:1c.4 PCI bridge <span class=o>[</span>0604<span class=o>]</span>: Intel Corporation 82801JI <span class=o>(</span>ICH10 Family<span class=o>)</span> PCI Express Root Port <span class=m>5</span> <span class=o>[</span>8086:3a48<span class=o>]</span>
</span></span><span class=line><span class=cl>        04:00.0 PCI bridge <span class=o>[</span>0604<span class=o>]</span>: Tundra Semiconductor Corp. Tsi381 PCIe to PCI Bridge <span class=o>[</span>10e3:8111<span class=o>]</span> <span class=o>(</span>rev 02<span class=o>)</span>
</span></span><span class=line><span class=cl>        05:00.0 Multimedia audio controller <span class=o>[</span>0401<span class=o>]</span>: Creative Labs CA0108/CA10300 <span class=o>[</span>Sound Blaster Audigy Series<span class=o>]</span> <span class=o>[</span>1102:0008<span class=o>]</span>
</span></span><span class=line><span class=cl>        06:00.0 Ethernet controller <span class=o>[</span>0200<span class=o>]</span>: Broadcom Inc. and subsidiaries NetXtreme BCM5755 Gigabit Ethernet PCI Express <span class=o>[</span>14e4:16
</span></span><span class=line><span class=cl>7b<span class=o>]</span> <span class=o>(</span>rev 02<span class=o>)</span>
</span></span></code></pre></div><p>这是我们最不想遇到的一种情况因为我额外添加的声卡是和网卡以及其他的pcie 端口是在一个组里面的好在是板载的声卡是独立的
接下来是我们的额外的usb卡的信息</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>IOMMU Group 19:
</span></span><span class=line><span class=cl>        00:1e.0 PCI bridge <span class=o>[</span>0604<span class=o>]</span>: Intel Corporation <span class=m>82801</span> PCI Bridge <span class=o>[</span>8086:244e<span class=o>]</span> <span class=o>(</span>rev 90<span class=o>)</span>
</span></span><span class=line><span class=cl>        07:0d.0 USB controller <span class=o>[</span>0c03<span class=o>]</span>: NEC Corporation OHCI USB Controller <span class=o>[</span>1033:0035<span class=o>]</span> <span class=o>(</span>rev 43<span class=o>)</span>
</span></span><span class=line><span class=cl>        07:0d.1 USB controller <span class=o>[</span>0c03<span class=o>]</span>: NEC Corporation OHCI USB Controller <span class=o>[</span>1033:0035<span class=o>]</span> <span class=o>(</span>rev 43<span class=o>)</span>
</span></span><span class=line><span class=cl>        07:0d.2 USB controller <span class=o>[</span>0c03<span class=o>]</span>: NEC Corporation uPD72010x USB 2.0 Controller <span class=o>[</span>1033:00e0<span class=o>]</span> <span class=o>(</span>rev 04<span class=o>)</span>
</span></span></code></pre></div><p>还有最为关键的显卡的信息</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>IOMMU Group 21:
</span></span><span class=line><span class=cl>        01:00.0 VGA compatible controller <span class=o>[</span>0300<span class=o>]</span>: NVIDIA Corporation GK107GL <span class=o>[</span>Quadro K2000<span class=o>]</span> <span class=o>[</span>10de:0ffe<span class=o>]</span> <span class=o>(</span>rev a1<span class=o>)</span>
</span></span><span class=line><span class=cl>        01:00.1 Audio device <span class=o>[</span>0403<span class=o>]</span>: NVIDIA Corporation GK107 HDMI Audio Controller <span class=o>[</span>10de:0e1b<span class=o>]</span> <span class=o>(</span>rev a1<span class=o>)</span>
</span></span><span class=line><span class=cl>IOMMU Group 22:
</span></span><span class=line><span class=cl>        02:00.0 VGA compatible controller <span class=o>[</span>0300<span class=o>]</span>: NVIDIA Corporation GF119 <span class=o>[</span>GeForce GT <span class=m>620</span> OEM<span class=o>]</span> <span class=o>[</span>10de:1049<span class=o>]</span> <span class=o>(</span>rev a1<span class=o>)</span>
</span></span><span class=line><span class=cl>        02:00.1 Audio device <span class=o>[</span>0403<span class=o>]</span>: NVIDIA Corporation GF119 HDMI Audio Controller <span class=o>[</span>10de:0e08<span class=o>]</span> <span class=o>(</span>rev a1<span class=o>)</span>
</span></span></code></pre></div><p>修改grub配置文件在我们的 <code>GRUB_CMDLINE_LINUX</code>这行追加</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>vfio-pci.ids<span class=o>=</span>8086:3a3e,8086:244e,1033:0035,1033:0035,1033:00e0,10de:0ffe,10de:0e1b
</span></span></code></pre></div><p>更新grub并重启</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>grub-mkconfig -o /boot/grub/grub.cfg
</span></span></code></pre></div><p>如果你的第二张显卡是插着显示器的你就可以看到引导到遮盖的pci设备的时候会卡在那里但是另外一个显示器是引导到了系统。</p><h2 id=部署虚拟机 class=headerLink><a href=#%e9%83%a8%e7%bd%b2%e8%99%9a%e6%8b%9f%e6%9c%ba class=header-mark></a>部署虚拟机</h2><p>在这个章节我们将会部署一台windows10的虚拟机。</p><p>准备条件</p><ul><li>Windows 10 镜像</li><li>Quadro 显卡驱动</li></ul><p>准备好这些之后就可以开始安装了，首先创建一个虚拟机磁盘：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>qemu-img create -f qcow2 /etc/libvirt/storage/windows10.qcow2 200G
</span></span></code></pre></div><p>如果你开了selinux不要忘记改一下selinux的布尔值:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>setsebool -P <span class=nv>virt_use_vfio</span><span class=o>=</span>on
</span></span><span class=line><span class=cl>setsebool -P <span class=nv>virt_use_sysfs</span><span class=o>=</span>on
</span></span></code></pre></div><p>安装windows10虚拟机</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo virt-install --virt-type<span class=o>=</span>kvm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--name<span class=o>=</span>windows10 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--memory<span class=o>=</span><span class=m>8196</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--vcpus<span class=o>=</span><span class=m>6</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--boot uefi <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--machine q35 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--cpu<span class=o>=</span>host-passthrough <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--file<span class=o>=</span>/etc/libvirt/storage/windows10.qcow2 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--cdrom<span class=o>=</span>/etc/libvirt/storage/iso/windows10.iso <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--os-variant win10 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--network <span class=nv>bridge</span><span class=o>=</span>br0,model<span class=o>=</span>e1000 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--graphics<span class=o>=</span>vnc,password<span class=o>=</span>passwd,listen<span class=o>=</span>0.0.0.0,port<span class=o>=</span><span class=m>5900</span>
</span></span></code></pre></div><p>然后使用vnc连接到这台虚拟机进行安装</p><p><figure><a class=lightgallery href=../../images/gentoo_kvm_begin_install.png title=../../images/gentoo_kvm_begin_install.png data-thumbnail=../../images/gentoo_kvm_begin_install.png><img loading=lazy src=../../images/gentoo_kvm_begin_install.png srcset="../../images/gentoo_kvm_begin_install.png, ../../images/gentoo_kvm_begin_install.png 1.5x, ../../images/gentoo_kvm_begin_install.png 2x" sizes=auto alt=../../images/gentoo_kvm_begin_install.png></a></figure></p><p>安装windows的步骤我就不一一赘述。</p><h3 id=添加pci设备 class=headerLink><a href=#%e6%b7%bb%e5%8a%a0pci%e8%ae%be%e5%a4%87 class=header-mark></a>添加PCI设备</h3><p>现在离成功只有一步添加PCI设备了，在关闭虚拟机之后添加对应的pci设备。</p><p>通过 nodedev-list 查看宿主机的设备。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>virsh nodedev-list --tree <span class=p>|</span>grep pci
</span></span></code></pre></div><p>从中找到和我们设备一一对应的地址记下来</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>  +- pci_0000_00_01_0
</span></span><span class=line><span class=cl>  <span class=p>|</span>   +- pci_0000_01_00_0
</span></span><span class=line><span class=cl>  <span class=p>|</span>   +- pci_0000_01_00_1
</span></span></code></pre></div><p>比如说这个地址是我们的显卡地址我们就需要记住这2个地址分配的时候要一起分配到虚拟机里面</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>pci_0000_01_00_0
</span></span><span class=line><span class=cl>pci_0000_01_00_1
</span></span></code></pre></div><p>我们可以用virsh 的 nodedev-dumpxml 子命令dump出来一份xml</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>virsh nodedev-dumpxml pci_0000_01_00_0
</span></span></code></pre></div><p>从输出中摘出需要记住的部分</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nv>bus</span><span class=o>=</span><span class=s1>&#39;1&#39;</span>
</span></span><span class=line><span class=cl><span class=nv>slot</span><span class=o>=</span><span class=s1>&#39;0&#39;</span>
</span></span><span class=line><span class=cl><span class=k>function</span><span class=o>=</span><span class=s1>&#39;0&#39;</span>
</span></span></code></pre></div><p>编辑虚拟机文件</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>virsh edit windows10
</span></span></code></pre></div><p>添加例子如
每个都需需要如上述这样添加
然后启动windows虚拟机</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>virsh start windows10
</span></span></code></pre></div><p>再使用vnc连接到虚拟机在系统里面将N卡驱动安装好，然后关机。
备份一份xml文件然后将vnc的删除。
最终的文件可以参考我的例子
最后来一个任务管理器的截图</p><p><figure><a class=lightgallery href=../../images/gentoo_kvm_windows10.png title=../../images/gentoo_kvm_windows10.png data-thumbnail=../../images/gentoo_kvm_windows10.png><img loading=lazy src=../../images/gentoo_kvm_windows10.png srcset="../../images/gentoo_kvm_windows10.png, ../../images/gentoo_kvm_windows10.png 1.5x, ../../images/gentoo_kvm_windows10.png 2x" sizes=auto alt=../../images/gentoo_kvm_windows10.png></a></figure></p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2024-03-28</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><button title="Share on Twitter" data-sharer=twitter data-url=https://blog.plz.ac/posts/gentoo-kvm-pci-passthrough/ data-title="Gentoo PCI KVM设备直通" data-hashtags=Linux,Gentoo,KVM,QEMU,Passthrough><span class="fab fa-twitter fa-fw"></span></button><button title="Share on Facebook" data-sharer=facebook data-url=https://blog.plz.ac/posts/gentoo-kvm-pci-passthrough/ data-hashtag=Linux><span class="fab fa-facebook-square fa-fw"></span></button><button title="Share on Linkedin" data-sharer=linkedin data-url=https://blog.plz.ac/posts/gentoo-kvm-pci-passthrough/><span class="fab fa-linkedin fa-fw"></span></button><button title="Share on WhatsApp" data-sharer=whatsapp data-url=https://blog.plz.ac/posts/gentoo-kvm-pci-passthrough/ data-title="Gentoo PCI KVM设备直通" data-web><span class="fab fa-whatsapp fa-fw"></span></button><button title="Share on Reddit" data-sharer=reddit data-url=https://blog.plz.ac/posts/gentoo-kvm-pci-passthrough/><span class="fab fa-reddit fa-fw"></span></button><button title="Share on Line" data-sharer=line data-url=https://blog.plz.ac/posts/gentoo-kvm-pci-passthrough/ data-title="Gentoo PCI KVM设备直通"><span data-svg-src=/lib/simple-icons/icons/line.min.svg></span></button><button title="Share on Blogger" data-sharer=blogger data-url=https://blog.plz.ac/posts/gentoo-kvm-pci-passthrough/ data-title="Gentoo PCI KVM设备直通" data-description="Gentoo Riscv Keyword"><span class="fab fa-blogger fa-fw"></span></button><button title="Share on Evernote" data-sharer=evernote data-url=https://blog.plz.ac/posts/gentoo-kvm-pci-passthrough/ data-title="Gentoo PCI KVM设备直通"><span class="fab fa-evernote fa-fw"></span></button><button title="Share on Trello" data-sharer=trello data-url=https://blog.plz.ac/posts/gentoo-kvm-pci-passthrough/ data-title="Gentoo PCI KVM设备直通" data-description="Gentoo Riscv Keyword"><span class="fab fa-trello fa-fw"></span></button><script>function shareOnMastodon(e,t){const o="share_mastodon_domain",i=localStorage.getItem(o)??"mastodon.social",n=prompt("Enter your Mastodon domain",i);if(n===null)return;localStorage.setItem(o,n);const a=e+`

`+t,s=new URL("https://"+n);s.pathname="share",s.searchParams.append("text",a),window.open(s,"_blank","width=500,height=500,left=500,toolbar=0,status=0")}</script>
<button title="Share on Mastodon" onclick='shareOnMastodon("Gentoo PCI KVM设备直通","https://blog.plz.ac/posts/gentoo-kvm-pci-passthrough/")'><span class="fab fa-mastodon fa-fw"></span></button></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/linux/>Linux</a>,&nbsp;<a href=/tags/gentoo/>Gentoo</a>,&nbsp;<a href=/tags/kvm/>KVM</a>,&nbsp;<a href=/tags/qemu/>QEMU</a>,&nbsp;<a href=/tags/passthrough/>Passthrough</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/gentoo-rpi4/ class=prev rel=prev title="Gentoo Raspberry PI 4"><i class="fas fa-angle-left fa-fw"></i>Gentoo Raspberry PI 4</a>
<a href=/posts/mysql-mm/ class=next rel=next title="Mysql 双主部署">Mysql 双主部署<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=utterances></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>Utterances</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreferrer" title="Hugo 0.110.0">Hugo</a>&nbsp;|&nbsp;Theme - <a href=https://github.com/HEIGE-PCloud/DoIt target=_blank rel="noopener noreferrer" title="DoIt 0.4.0"><i class="far fa-edit fa-fw"></i> DoIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2023 - 2024</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://blog.plz.ac target=_blank rel="noopener noreferrer">Chris Su</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class=footer-line></div><div class=footer-line></div></div><script>"serviceWorker"in navigator&&(navigator.serviceWorker.register("/sw.min.js",{scope:"/"}).then(function(){}),navigator.serviceWorker.ready.then(function(){}))</script></footer></div><div id=fixed-buttons><a href=#back-to-top id=back-to-top-button class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw"></i></a></div><div class=assets><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/katex/copy-tex.min.css><noscript><link rel=stylesheet href=/lib/katex/copy-tex.min.css></noscript><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:10},comment:{utterances:{darkTheme:"github-dark",issueTerm:"pathname",label:"",lightTheme:"github-light",repo:"slchris/blog.plz.ac-comments"}},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},sharerjs:!0,table:{sort:!0}}</script><script type=text/javascript src=/lib/tablesort/tablesort.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js defer></script><script type=text/javascript src=/lib/katex/auto-render.min.js defer></script><script type=text/javascript src=/lib/katex/copy-tex.min.js defer></script><script type=text/javascript src=/lib/katex/mhchem.min.js defer></script><script type=text/javascript src=/js/katex.min.js defer></script><script type=text/javascript src=/js/theme.min.js defer></script><script type=text/javascript src=/js/utterances.min.js defer></script><script async defer data-website-id=83973c25-5323-4ad6-952e-f39357769191 src=https://umami.plz.ac/script.js data-host-url=https://umami.plz.ac data-domains=blog.plz.ac></script></div></body></html>